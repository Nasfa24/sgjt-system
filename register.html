<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daftar SGJT</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h2>Bergabung Sekarang</h2>
        <p>Upline Anda: <span id="upline-name">Loading...</span></p>
        
        <form id="registerForm">
            <input type="text" id="nama" placeholder="Nama Lengkap" required><br>
            <input type="email" id="email" placeholder="Email" required><br>
            <input type="password" id="password" placeholder="Password" required><br>
            
            <label>Bank (Wajib BCA)</label>
            <select id="bank" disabled>
                <option value="BCA" selected>BCA</option>
            </select><br>
            
            <input type="number" id="rekening" placeholder="Nomor Rekening BCA" required><br>
            <input type="number" id="whatsapp" placeholder="Nomor WhatsApp (628...)" required><br>
            
            <button type="submit" id="btnDaftar">Daftar & Kunci Posisi</button>
        </form>
    </div>

    <script type="module">
        import { auth, db, createUserWithEmailAndPassword, doc, setDoc, getDoc } from './app.js';

        const registerForm = document.getElementById('registerForm');
        
        // 1. Ambil Referral ID dari URL (contoh: register.html?ref=KODE_UPLINE)
        const urlParams = new URLSearchParams(window.location.search);
        const refCode = urlParams.get('ref');

        // Cek Validitas Upline saat halaman dibuka
        async function checkUpline() {
            if(!refCode) {
                alert("Anda tidak bisa daftar tanpa Link Referral!");
                document.getElementById('btnDaftar').disabled = true;
                return;
            }
            
            const uplineSnap = await getDoc(doc(db, "users", refCode));
            if (uplineSnap.exists()) {
                document.getElementById('upline-name').innerText = uplineSnap.data().nama;
            } else {
                alert("Kode Upline Salah!");
                document.getElementById('btnDaftar').disabled = true;
            }
        }
        checkUpline();

        // 2. Logic Pendaftaran
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const nama = document.getElementById('nama').value;
            const rek = document.getElementById('rekening').value;
            const wa = document.getElementById('whatsapp').value;

            try {
                // A. Buat Akun Auth
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // B. Ambil Data Struktur Upline
                const uplineSnap = await getDoc(doc(db, "users", refCode));
                const uplineData = uplineSnap.data();

                // C. ALGORITMA GESER POSISI (SHIFTING)
                // Upline Data punya: { kawan1: 'A', kawan2: 'B', kawan3: 'C', kawan4: 'D' }
                // Kita (Member Baru) akan punya:
                const myUplines = {
                    kawan_1: uplineData.uplines.kawan_2, // Posisi 2 naik ke 1
                    kawan_2: uplineData.uplines.kawan_3, // Posisi 3 naik ke 2
                    kawan_3: uplineData.uplines.kawan_4, // Posisi 4 naik ke 3
                    kawan_4: refCode // Referrer (Si Pengajak) masuk ke 4
                };

                // D. Simpan ke Database
                await setDoc(doc(db, "users", user.uid), {
                    nama: nama,
                    email: email,
                    bank: "BCA",
                    rekening: rek,
                    whatsapp: wa,
                    uplines: myUplines,
                    status: "PENDING", // Belum transfer
                    createdAt: new Date()
                });

                alert("Pendaftaran Berhasil! Silakan Transfer.");
                window.location.href = "dashboard.html";

            } catch (error) {
                console.error(error);
                alert("Error: " + error.message);
            }
        });
    </script>
</body>
</html>