<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daftar SGJT</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 400px; margin: auto; }
        input, select, button { width: 100%; padding: 10px; margin: 5px 0; }
        button { background: #007bff; color: white; border: none; cursor: pointer; }
        button:disabled { background: #ccc; }
        .error { color: red; font-size: 0.9em; }
    </style>
</head>
<body>
    <h2>Bergabung Sekarang</h2>
    <p>Upline Anda: <strong><span id="upline-name">Memuat...</span></strong></p>
    
    <form id="registerForm">
        <input type="text" id="nama" placeholder="Nama Lengkap" required>
        <input type="email" id="email" placeholder="Email" required>
        <input type="password" id="password" placeholder="Password (Min 6 digit)" required>
        
        <label>Bank (Wajib BCA)</label>
        <select id="bank" disabled><option value="BCA" selected>BCA</option></select>
        
        <input type="number" id="rekening" placeholder="Nomor Rekening BCA" required>
        <input type="number" id="whatsapp" placeholder="Nomor WhatsApp (628...)" required>
        
        <button type="submit" id="btnDaftar" disabled>Daftar & Kunci Posisi</button>
        <p id="msg" class="error"></p>
    </form>

    <script type="module">
        import { auth, db, createUserWithEmailAndPassword, doc, setDoc, getDoc } from './app.js';

        const registerForm = document.getElementById('registerForm');
        const msg = document.getElementById('msg');
        
        // Ambil Referral ID dari URL
        const urlParams = new URLSearchParams(window.location.search);
        const refCode = urlParams.get('ref');

        // Cek Upline
        async function checkUpline() {
            if(!refCode) {
                msg.innerText = "Error: Link tidak valid (Tidak ada Kode Referral).";
                return;
            }
            
            try {
                const uplineSnap = await getDoc(doc(db, "users", refCode));
                if (uplineSnap.exists()) {
                    document.getElementById('upline-name').innerText = uplineSnap.data().nama;
                    document.getElementById('btnDaftar').disabled = false;
                } else {
                    msg.innerText = "Kode Referral Salah/Tidak Ditemukan!";
                }
            } catch (e) {
                msg.innerText = "Error Sistem: " + e.message;
            }
        }
        checkUpline();

        // Proses Daftar
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const nama = document.getElementById('nama').value;
            const rek = document.getElementById('rekening').value;
            const wa = document.getElementById('whatsapp').value;

            try {
                msg.innerText = "Memproses pendaftaran...";
                
                // 1. Buat Auth
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // 2. Ambil Data Upline
                const uplineSnap = await getDoc(doc(db, "users", refCode));
                const uplineData = uplineSnap.data();

                // 3. LOGIKA GESER (SHIFTING)
                const myUplines = {
                    kawan_1: uplineData.uplines.kawan_2,
                    kawan_2: uplineData.uplines.kawan_3,
                    kawan_3: uplineData.uplines.kawan_4,
                    kawan_4: refCode // Referrer masuk sini
                };

                // 4. Simpan Database
                await setDoc(doc(db, "users", user.uid), {
                    uid: user.uid,
                    nama: nama,
                    email: email,
                    bank: "BCA",
                    rekening: rek,
                    no_wa: wa,
                    uplines: myUplines,
                    status: "PENDING",
                    createdAt: new Date()
                });

                alert("Berhasil! Silakan Login.");
                window.location.href = "index.html";

            } catch (error) {
                console.error(error);
                msg.innerText = "Gagal: " + error.message;
            }
        });
    </script>
</body>
</html>